# Módulo: Relatórios

## Funcionalidade

Business Intelligence e geração de relatórios gerenciais, operacionais e estratégicos com análises avançadas e exportação em múltiplos formatos.

### Categorias de Relatórios

**Relatórios Gerenciais**
- Resumo executivo mensal/anual
- Performance geral do escritório
- KPIs principais
- Comparativos entre períodos
- Análise de tendências

**Relatórios Operacionais**
- Produtividade por advogado
- Distribuição de processos
- Prazos cumpridos vs perdidos
- Tempo médio de resposta
- Volume de trabalho

**Relatórios Financeiros**
- DRE detalhado
- Fluxo de caixa projetado
- Inadimplência detalhada
- Receita por área/cliente/advogado
- Análise de custos

**Relatórios de Clientes**
- Perfil de clientes
- Lifetime value
- Taxa de retenção
- Origem de captação
- Satisfação (NPS)

**Relatórios de Processos**
- Distribuição por fase/área
- Taxa de êxito
- Tempo médio de tramitação
- Análise de riscos
- Movimentações por período

**Relatórios Customizados**
- Criação de relatórios próprios
- Seleção de campos
- Filtros avançados
- Fórmulas calculadas
- Templates salvos

### Interface de Relatórios

**Construtor Visual**
- Drag and drop de campos
- Filtros interativos
- Agrupamentos
- Ordenação
- Formatação condicional
- Preview em tempo real

**Tipos de Visualização**
- Tabelas
- Gráficos (linha, barra, pizza, área)
- Cards de métricas
- Mapas de calor
- Funil
- Gauge/medidor
- Timeline
- Treemap

**Filtros Disponíveis**
- Período (data início/fim)
- Cliente(s)
- Advogado(s)
- Área jurídica
- Status
- Tribunal
- Valor (faixas)
- Tags
- Customizados por relatório

**Configurações de Exportação**
- PDF formatado
- Excel (.xlsx)
- CSV
- JSON
- Imagem (PNG/JPEG)
- Envio por email
- Link compartilhável

### Relatórios Pré-Configurados

**1. Resumo Executivo Mensal**
- Total de novos processos
- Receita do mês vs meta
- Taxa de inadimplência
- Novos clientes
- Processos concluídos
- Prazos cumpridos/perdidos
- Top 5 clientes por receita
- Gráficos de evolução

**2. Performance por Advogado**
- Processos ativos
- Novos processos no período
- Processos concluídos
- Receita gerada
- Horas faturadas
- Taxa de êxito
- Prazos cumpridos
- SLA médio de respostas

**3. Análise de Carteira de Clientes**
- Total de clientes ativos
- Novos clientes no período
- Clientes inativos
- Distribuição por origem
- Lifetime value médio
- Taxa de retenção
- Churn rate
- Segmentação por porte/área

**4. Dashboard Processual**
- Processos por fase
- Processos por instância
- Distribuição por área
- Movimentações do mês
- Audiências realizadas
- Taxa de êxito por área
- Tempo médio de tramitação
- Processos críticos (alto risco)

**5. Relatório Financeiro Completo**
- Receita total (realizada e projetada)
- Despesas por categoria
- Lucro líquido e margem
- Fluxo de caixa
- Contas a receber aging
- Taxa de inadimplência
- Receita por área/advogado
- Comparativo com período anterior

**6. Análise de Captação**
- Novos clientes por origem
- ROI por canal de marketing
- Taxa de conversão (consulta → contrato)
- Custo de aquisição por cliente (CAC)
- Fontes mais rentáveis
- Indicações (quem indicou mais)
- Performance de campanhas

**7. Relatório de Publicações**
- Total de publicações capturadas
- Publicações por tribunal
- Publicações urgentes
- Taxa de processamento
- Tempo médio de análise
- Publicações não lidas
- Distribuição por tipo

**8. Análise de Prazos**
- Total de prazos no período
- Prazos cumpridos
- Prazos perdidos
- Taxa de cumprimento
- Por advogado responsável
- Por área
- Prazos críticos em aberto

**9. Relatório de Consultivo**
- Consultas atendidas
- Por tipo (parecer, contrato, etc)
- SLA médio de resposta
- Taxa de aprovação na revisão
- Receita consultiva
- Horas trabalhadas
- Análise de produtividade

**10. Relatório de Satisfação do Cliente**
- NPS geral
- Avaliações por serviço
- Feedbacks e comentários
- Taxa de reclamações
- Resolução de problemas
- Tempo de resposta médio

### Funcionalidades Especiais

**Dashboards Interativos**
- Múltiplos widgets em uma tela
- Atualização em tempo real
- Drill-down em dados
- Filtros globais
- Comparação entre períodos
- Alertas visuais

**Agendamento de Relatórios**
- Geração automática periódica
- Envio por email
- Destinatários múltiplos
- Formatos variados
- Horário personalizado
- Condições de envio

**Benchmarking**
- Comparação com dados históricos
- Metas vs realizado
- Médias do mercado (quando disponível)
- Evolução temporal
- Análise de desvios

**Análises Preditivas (IA)**
- Previsão de receitas
- Tendências de inadimplência
- Probabilidade de êxito de processos
- Projeção de carga de trabalho
- Identificação de padrões

**Relatórios Colaborativos**
- Compartilhamento com equipe
- Comentários e anotações
- Versionamento
- Permissões de acesso
- Histórico de alterações

**Templates de Relatório**
- Biblioteca de modelos
- Templates por área
- Templates institucionais
- Customização de branding
- Reutilização

### Integrações com IA

**Via Chat do Dashboard**
- "Gere relatório mensal de performance"
- "Mostre evolução de receitas nos últimos 6 meses"
- "Compare produtividade dos advogados este trimestre"
- "Analise taxa de êxito em processos trabalhistas"
- "Crie relatório de clientes inativos para reativação"
- "Qual a previsão de receita para próximo mês?"
- "Identifique processos com risco de perda de prazo"
- "Gere dashboard executivo para reunião de sócios"

**Geração Automática com IA**
- Análise de dados e insights
- Geração de narrativas explicativas
- Identificação de anomalias
- Sugestões de ações
- Comparações relevantes
- Highlights automáticos

**Análise Textual**
- Resumos executivos gerados por IA
- Interpretação de tendências
- Recomendações baseadas em dados
- Explicação de variações significativas

**Sugestões Proativas**
- "Receita caiu 15% em relação ao mês passado. Analisar causas?"
- "3 advogados estão abaixo da meta. Gerar relatório individual?"
- "Taxa de inadimplência subiu. Deseja relatório detalhado?"
- "Novo recorde de captação este mês. Compartilhar com equipe?"

### Métricas e KPIs Rastreados

**Financeiros**
- Receita total
- Margem de lucro
- Ticket médio
- LTV (Lifetime Value)
- CAC (Custo de Aquisição)
- Taxa de inadimplência
- Fluxo de caixa
- EBITDA

**Operacionais**
- Processos ativos
- Processos novos/concluídos
- Taxa de êxito
- Tempo médio de tramitação
- Prazos cumpridos/perdidos (%)
- Movimentações processadas
- Publicações capturadas
- SLA médio

**Clientes**
- Total de clientes ativos
- Novos clientes
- Taxa de retenção (%)
- Churn rate (%)
- NPS (Net Promoter Score)
- CSAT (Customer Satisfaction)
- Taxa de conversão

**Produtividade**
- Horas faturadas
- Horas trabalhadas totais
- Taxa de utilização (%)
- Processos por advogado
- Receita por advogado
- Consultas respondidas
- Tempo médio de resposta

## Banco de Dados

### Tabelas Necessárias

**relatorios_templates**
```
- id (uuid, PK)
- escritorio_id (uuid, FK)
- nome (text)
- categoria (text: 'gerencial', 'operacional', 'financeiro', 'clientes', 'processos', 'customizado')
- descricao (text, nullable)
- tipo_visualizacao (text: 'tabela', 'grafico', 'dashboard')
- config (jsonb) - campos, filtros, agrupamentos
- publico (boolean) - visível para todos
- criado_por (uuid, FK profiles)
- ativo (boolean)
- created_at (timestamp)
- updated_at (timestamp)
```

**relatorios_agendados**
```
- id (uuid, PK)
- template_id (uuid, FK relatorios_templates)
- frequencia (text: 'diaria', 'semanal', 'mensal', 'trimestral')
- dia_semana (integer, nullable) - 0=dom, 6=sab
- dia_mes (integer, nullable)
- hora (time)
- destinatarios (text[]) - emails
- formato (text: 'pdf', 'excel', 'csv')
- ativo (boolean)
- ultimo_envio (timestamp, nullable)
- proximo_envio (timestamp)
- created_at (timestamp)
```

**relatorios_gerados**
```
- id (uuid, PK)
- template_id (uuid, FK relatorios_templates, nullable)
- titulo (text)
- tipo (text)
- parametros (jsonb) - filtros aplicados
- arquivo_url (text, nullable)
- formato (text)
- gerado_por (uuid, FK profiles)
- data_inicio_periodo (date)
- data_fim_periodo (date)
- created_at (timestamp)
```

**relatorios_compartilhados**
```
- id (uuid, PK)
- relatorio_id (uuid, FK relatorios_gerados)
- compartilhado_com (uuid, FK profiles, nullable)
- link_publico (text, nullable)
- expira_em (timestamp, nullable)
- visualizacoes (integer)
- created_at (timestamp)
```

**metricas_cache**
```
- id (uuid, PK)
- escritorio_id (uuid, FK)
- categoria (text: 'financeiro', 'operacional', 'clientes', 'produtividade')
- metrica (text) - nome da métrica
- periodo (text: 'dia', 'semana', 'mes', 'ano')
- data_referencia (date)
- valor (numeric)
- valor_anterior (numeric, nullable) - período anterior
- variacao_percentual (numeric, nullable)
- metadata (jsonb, nullable) - detalhes adicionais
- calculado_em (timestamp)
```

**kpis_metas**
```
- id (uuid, PK)
- escritorio_id (uuid, FK)
- kpi (text)
- periodo (text: 'mensal', 'trimestral', 'anual')
- ano (integer)
- mes (integer, nullable)
- trimestre (integer, nullable)
- valor_meta (numeric)
- valor_realizado (numeric)
- percentual_atingimento (numeric)
- updated_at (timestamp)
```

**dashboards_personalizados**
```
- id (uuid, PK)
- user_id (uuid, FK profiles)
- nome (text)
- layout (jsonb) - configuração de widgets
- widgets (jsonb) - array de widgets
- filtros_padrao (jsonb, nullable)
- compartilhado (boolean)
- created_at (timestamp)
- updated_at (timestamp)
```

**analises_ia**
```
- id (uuid, PK)
- escritorio_id (uuid, FK)
- tipo (text: 'previsao', 'tendencia', 'anomalia', 'recomendacao')
- categoria (text: 'financeiro', 'operacional', etc)
- titulo (text)
- descricao (text)
- dados_entrada (jsonb)
- resultado (jsonb)
- confianca (numeric)
- acao_sugerida (text, nullable)
- created_at (timestamp)
- valido_ate (timestamp)
```

**nps_avaliacoes**
```
- id (uuid, PK)
- cliente_id (uuid, FK clientes)
- processo_id (uuid, FK processos, nullable)
- consulta_id (uuid, FK consultas, nullable)
- nota (integer) - 0 a 10
- categoria (text: 'promotor', 'neutro', 'detrator')
- feedback (text, nullable)
- respondido_em (timestamp)
- created_at (timestamp)
```

### Views

**v_metricas_dashboard**
```
Principais métricas consolidadas
Valores atuais e comparativos
Para exibição no dashboard principal
```

**v_performance_advogados**
```
Métricas de produtividade
Por advogado
Ranking
```

**v_receita_analise**
```
Análise detalhada de receitas
Por múltiplas dimensões
Período, área, cliente, advogado
```

**v_relatorios_recentes**
```
Últimos relatórios gerados
Para acesso rápido
```

### Functions

**gerar_relatorio(template_id uuid, parametros jsonb)**
- Busca configuração do template
- Aplica filtros dos parâmetros
- Executa queries necessárias
- Gera visualizações
- Compila em formato solicitado
- Salva arquivo
- Retorna URL do relatório

**calcular_metricas(categoria text, periodo text, data_referencia date)**
- Calcula todas métricas da categoria
- Para o período especificado
- Compara com período anterior
- Salva em cache
- Retorna métricas calculadas

**gerar_insights_ia(categoria text, periodo text)**
- Analisa dados do período
- Identifica padrões e anomalias
- Gera insights textuais
- Sugere ações
- Salva análise
- Retorna insights

**prever_metrica_ia(metrica text, horizonte_meses integer)**
- Busca histórico da métrica
- Aplica modelo preditivo
- Gera previsão
- Calcula intervalo de confiança
- Retorna previsão

**calcular_nps(periodo_inicio date, periodo_fim date)**
- Busca avaliações do período
- Calcula NPS
- Categoriza respondentes
- Analisa feedbacks
- Retorna NPS e detalhes

**comparar_periodos(metrica text, periodo1 jsonb, periodo2 jsonb)**
- Calcula métrica para ambos períodos
- Compara valores
- Calcula variação
- Identifica causas (via IA)
- Retorna comparação

**gerar_dashboard_executivo(data_referencia date)**
- Consolida principais métricas
- Gera gráficos
- Cria narrativa com IA
- Formata relatório executivo
- Retorna dashboard

### Triggers

**update_metricas_cache**
- Quando dados relevantes mudam
- Invalida cache da métrica
- Agenda recálculo

**relatorio_gerado_notify**
- Ao gerar relatório agendado
- Envia notificações
- Registra envio

### Scheduled Functions

**calcular_metricas_diarias**
- Roda diariamente às 6h
- Calcula métricas operacionais
- Atualiza cache
- Gera alertas se necessário

**calcular_metricas_mensais**
- Roda dia 1 de cada mês
- Consolida métricas do mês anterior
- Compara com metas
- Gera relatório automático

**gerar_relatorios_agendados**
- Roda a cada hora
- Verifica relatórios para gerar
- Gera e envia
- Atualiza próximo envio

**analisar_tendencias_ia**
- Roda semanalmente
- Analisa métricas da semana
- Identifica tendências
- Gera insights
- Notifica gestores

**limpar_relatorios_antigos**
- Roda mensalmente
- Arquiva relatórios > 1 ano
- Mantém base limpa

### RLS

- Usuários veem relatórios do próprio escritório
- Podem criar relatórios pessoais
- Podem ver relatórios compartilhados com eles
- Podem ver relatórios públicos do escritório
- Admins veem e editam todos relatórios
- Restrições por nível: alguns relatórios apenas para sócios/admins
